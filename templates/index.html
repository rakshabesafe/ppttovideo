<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presentation Video Generator</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 1000px; margin: auto; }
        h1, h2 { border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .container { display: flex; gap: 40px; }
        .col { flex: 1; }
        form { display: flex; flex-direction: column; gap: 10px; background: #f4f4f4; padding: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-pending, .status-processing { color: orange; }
        .status-synthesizing_audio { color: purple; }
        .status-assembling_video { color: teal; }
        .status-completed { color: green; }
        .status-failed { color: red; }
        
        .progress-detail {
            font-size: 0.9em;
            line-height: 1.4;
            max-width: 300px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            margin: 4px 0;
            white-space: pre-wrap;
        }
        
        .progress-detail.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .progress-detail.failed {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .hidden { display: none; }
        .cleanup-section { margin: 20px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; }
        .cleanup-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .cleanup-btn:hover { background: #c82333; }
        .cleanup-btn:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Presentation Video Generator</h1>
        <a href="/dashboard" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: 500;">üîß Dashboard</a>
    </div>

    <!-- Voice Test Section -->
    <div class="cleanup-section">
        <h3>üé§ Voice Test</h3>
        <p>Test voice synthesis independently to debug TTS issues</p>
        <form id="voice-test-form" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="test-text" placeholder="Enter text to synthesize..." style="flex: 2; min-width: 200px; padding: 8px;">
            <select id="test-voice" style="flex: 1; min-width: 150px; padding: 8px;">
                <option value="">Loading voices...</option>
            </select>
            <button type="submit" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîä Generate Audio</button>
        </form>
        <div id="voice-test-result" style="margin-top: 10px;"></div>
    </div>

    <div class="container">
        <div class="col">
            <h2>Step 1: Create or Select User</h2>
            <div id="user-selection">
                <button id="show-login-form">Login</button>
                <button id="show-create-form">Create User</button>
            </div>

            <form id="login-form" class="hidden">
                <h3>Login</h3>
                <label for="login-username">User Name:</label>
                <input type="text" id="login-username" name="login-username" required>
                <button type="submit">Login</button>
            </form>

            <form id="create-user-form">
                <h3>Create User</h3>
                <label for="username">User Name:</label>
                <input type="text" id="username" name="username" required>
                <button type="submit">Create User</button>
            </form>

            <div id="user-info" class="hidden">
                <h3>Current User: <span id="current-username"></span> (ID: <span id="current-user-id"></span>)</h3>
            </div>

            <div id="voice-clone-section" class="hidden">
                <h2>Step 2: Manage Voice Clones</h2>
                <form id="voice-clone-form" enctype="multipart/form-data">
                    <label for="clone-name">New Clone Name:</label>
                    <input type="text" id="clone-name" name="clone-name" required>
                    <label for="wav-file">Reference Audio file (WAV or MP3):</label>
                    <input type="file" id="wav-file" name="wav-file" accept=".wav,.mp3" required>
                    <button type="submit">Upload Voice Clone</button>
                </form>
                <h3>Existing Voice Clones:</h3>
                <ul id="voice-clone-list"></ul>
            </div>
        </div>

        <div class="col">
            <div id="presentation-section" class="hidden">
                <h2>Step 3: Create Presentation Video</h2>
                <form id="presentation-form" enctype="multipart/form-data">
                    <label for="pptx-file">PPTX file:</label>
                    <input type="file" id="pptx-file" name="pptx-file" accept=".pptx" required>
                    <label for="voice-clone-select">Select Voice Clone:</label>
                    <select id="voice-clone-select" name="voice-clone-select" required></select>
                    <button type="submit">Generate Video</button>
                </form>
            </div>
        </div>
    </div>

    <hr>

    <h2>Jobs Dashboard</h2>
    
    <div class="cleanup-section">
        <h3>üßπ Cleanup Jobs</h3>
        <p>Remove old completed and failed jobs along with their associated files (images, audio, videos).</p>
        <button id="cleanup-btn" class="cleanup-btn">Clean All Jobs</button>
        <span id="cleanup-status" style="margin-left: 15px; font-weight: bold;"></span>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>All Jobs</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="selectedJobCount" style="color: #6c757d; font-size: 14px;">0 selected</span>
            <button id="deleteSelectedJobsBtn" class="cleanup-btn" onclick="deleteSelectedJobs()" disabled>
                Delete Selected Jobs
            </button>
        </div>
    </div>
    
    <table id="jobs-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAllJobs" onchange="toggleSelectAllJobs()">
                </th>
                <th>Job ID</th>
                <th>User ID</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Job rows will be inserted here -->
        </tbody>
    </table>

    <script>
        const API_BASE_URL = "/api";
        let currentUserId = null;

        // Voice Test Functionality
        async function loadVoicesForTest() {
            try {
                const response = await fetch(`${API_BASE_URL}/voice-test/voices`);
                const voices = await response.json();
                
                const select = document.getElementById('test-voice');
                select.innerHTML = '<option value="">Select a voice...</option>';
                
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = `${voice.name} (${voice.type})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading voices:', error);
                document.getElementById('test-voice').innerHTML = '<option value="">Error loading voices</option>';
            }
        }

        async function testVoiceSynthesis(event) {
            event.preventDefault();
            
            const text = document.getElementById('test-text').value.trim();
            const voiceId = document.getElementById('test-voice').value;
            const resultDiv = document.getElementById('voice-test-result');
            
            if (!text) {
                resultDiv.innerHTML = '<span style="color: red;">Please enter text to synthesize</span>';
                return;
            }
            
            if (!voiceId) {
                resultDiv.innerHTML = '<span style="color: red;">Please select a voice</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span style="color: blue;">üîÑ Generating audio...</span>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/voice-test/test-voice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice_clone_id: parseInt(voiceId)
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    resultDiv.innerHTML = `
                        <span style="color: green;">‚úÖ Audio generated successfully!</span><br>
                        <audio controls style="margin-top: 10px;">
                            <source src="${audioUrl}" type="audio/wav">
                            Your browser does not support audio playback.
                        </audio><br>
                        <a href="${audioUrl}" download="test-voice.wav" style="color: #007bff; text-decoration: none; font-size: 14px; margin-top: 5px; display: inline-block;">üíæ Download Audio</a>
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<span style="color: red;">‚ùå Error: ${errorText}</span>`;
                }
            } catch (error) {
                console.error('Voice test error:', error);
                resultDiv.innerHTML = `<span style="color: red;">‚ùå Network error: ${error.message}</span>`;
            }
        }

        const userSelection = document.getElementById('user-selection');
        const loginForm = document.getElementById('login-form');
        const createUserForm = document.getElementById('create-user-form');
        const userInfo = document.getElementById('user-info');
        const voiceCloneSection = document.getElementById('voice-clone-section');
        const presentationSection = document.getElementById('presentation-section');

        document.getElementById('show-login-form').addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            createUserForm.classList.add('hidden');
        });

        document.getElementById('show-create-form').addEventListener('click', () => {
            loginForm.classList.add('hidden');
            createUserForm.classList.remove('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const response = await fetch(`${API_BASE_URL}/users/by_name/${username}`);

            if (response.ok) {
                const user = await response.json();
                currentUserId = user.id;
                document.getElementById('current-username').textContent = user.name;
                document.getElementById('current-user-id').textContent = user.id;
                userInfo.classList.remove('hidden');
                voiceCloneSection.classList.remove('hidden');
                presentationSection.classList.remove('hidden');
                userSelection.classList.add('hidden');
                loginForm.classList.add('hidden');
                createUserForm.classList.add('hidden');
                await loadVoiceClones();
                await loadAllJobs();
            } else {
                alert("Login failed. User not found.");
            }
        });

        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const response = await fetch(`${API_BASE_URL}/users/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: username, email: `${username}@example.com` })
            });

            if (response.ok) {
                const user = await response.json();
                currentUserId = user.id;
                document.getElementById('current-username').textContent = user.name;
                document.getElementById('current-user-id').textContent = user.id;
                userInfo.classList.remove('hidden');
                voiceCloneSection.classList.remove('hidden');
                presentationSection.classList.remove('hidden');
                userSelection.classList.add('hidden');
                loginForm.classList.add('hidden');
                createUserForm.classList.add('hidden');
                await loadVoiceClones();
                await loadAllJobs();
            } else {
                alert("Failed to create user. Maybe the email is already in use.");
            }
        });

        const voiceCloneForm = document.getElementById('voice-clone-form');
        voiceCloneForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('name', document.getElementById('clone-name').value);
            formData.append('owner_id', currentUserId);
            formData.append('file', document.getElementById('wav-file').files[0]);

            const response = await fetch(`${API_BASE_URL}/voice-clones/`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Voice clone uploaded successfully!');
                voiceCloneForm.reset();
                await loadVoiceClones();
            } else {
                alert('Failed to upload voice clone.');
            }
        });

        const presentationForm = document.getElementById('presentation-form');
        presentationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('owner_id', currentUserId);
            formData.append('voice_clone_id', document.getElementById('voice-clone-select').value);
            formData.append('file', document.getElementById('pptx-file').files[0]);

            const response = await fetch(`${API_BASE_URL}/presentations/`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Presentation job started!');
                presentationForm.reset();
                await loadAllJobs();
            } else {
                alert('Failed to start presentation job.');
            }
        });

        async function loadVoiceClones() {
            if (!currentUserId) return;
            const response = await fetch(`${API_BASE_URL}/voice-clones/user/${currentUserId}`);
            const clones = await response.json();

            const list = document.getElementById('voice-clone-list');
            const select = document.getElementById('voice-clone-select');
            list.innerHTML = '';
            select.innerHTML = '';

            clones.forEach(clone => {
                const listItem = document.createElement('li');
                listItem.textContent = `${clone.name} (ID: ${clone.id})`;
                list.appendChild(listItem);

                const optionItem = document.createElement('option');
                optionItem.value = clone.id;
                optionItem.textContent = `${clone.name} (ID: ${clone.id})`;
                select.appendChild(optionItem);
            });
        }

        async function loadAllJobs() {
             // For the MVP, we load all jobs, not just for the current user
            const response = await fetch(`${API_BASE_URL}/presentations/status/all`); // This endpoint doesn't exist yet, I'll need to add it
            if(!response.ok) return;
            const jobs = await response.json();
            const tbody = document.querySelector('#jobs-table tbody');
            tbody.innerHTML = '';
            jobs.forEach(job => addJobRow(job));
        }

        function addJobRow(job) {
            const tbody = document.querySelector('#jobs-table tbody');
            const row = document.createElement('tr');
            row.id = `job-${job.id}`;
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="job-checkbox" value="${job.id}" onchange="updateSelectedJobCount()">
                </td>
                <td>${job.id}</td>
                <td>${job.owner_id}</td>
                <td class="status-${job.status}" id="status-${job.id}">${job.status}</td>
                <td>${new Date(job.created_at).toLocaleString()}</td>
                <td id="action-${job.id}">
                    ${job.status === 'completed' ? `<a href="/api/presentations/download/${job.id}" target="_blank">Download</a>` : '<div id="progress-' + job.id + '">Loading progress...</div>'}
                </td>
            `;
            tbody.prepend(row);
            
            // Load detailed progress for non-completed jobs
            if (job.status !== 'completed') {
                loadJobProgress(job.id);
            }
        }

        async function loadJobProgress(jobId) {
            try {
                const response = await fetch(`${API_BASE_URL}/presentations/progress/${jobId}`);
                if (response.ok) {
                    const progress = await response.json();
                    updateJobProgress(progress);
                }
            } catch (error) {
                console.error(`Failed to load progress for job ${jobId}:`, error);
            }
        }

        function updateJobProgress(progress) {
            const statusCell = document.getElementById(`status-${progress.job_id}`);
            const progressDiv = document.getElementById(`progress-${progress.job_id}`);
            
            if (statusCell) {
                statusCell.textContent = progress.status;
                statusCell.className = `status-${progress.status}`;
            }
            
            if (progressDiv && progress.overall_progress) {
                // Convert newlines to <br> for HTML display
                const formattedProgress = progress.overall_progress.replace(/\n/g, '<br>');
                progressDiv.innerHTML = `<div class="progress-detail">${formattedProgress}</div>`;
            }
            
            // If completed, show download button
            if (progress.status === 'completed') {
                const actionCell = document.getElementById(`action-${progress.job_id}`);
                if (actionCell) {
                    actionCell.innerHTML = `<a href="/api/presentations/download/${progress.job_id}" target="_blank">Download</a>`;
                }
            }
        }

        function updateJobStatus(job) {
            const row = document.getElementById(`job-${job.id}`);
            if (row) {
                row.querySelector('td:nth-child(3)').textContent = job.status;
                row.querySelector('td:nth-child(3)').className = `status-${job.status}`;
                if (job.status === 'completed') {
                    document.getElementById(`action-${job.id}`).innerHTML = `<a href="/api/presentations/download/${job.id}" target="_blank">Download</a>`;
                } else {
                    // Load detailed progress for active jobs
                    loadJobProgress(job.id);
                }
            } else {
                addJobRow(job);
            }
        }

        // I need to add an endpoint to get all jobs. And a download endpoint.
        // Let's assume I will add GET /api/presentations/status/all
        // And GET /api/presentations/download/{job_id}
        // I will add these to presentations.py next.

        // Cleanup functionality
        document.getElementById('cleanup-btn').addEventListener('click', async () => {
            const cleanupBtn = document.getElementById('cleanup-btn');
            const cleanupStatus = document.getElementById('cleanup-status');
            
            // Confirmation dialog
            const confirmed = confirm(
                'Are you sure you want to clean up all completed and failed jobs?\n\n' +
                'This will permanently delete:\n' +
                '‚Ä¢ Job records from database\n' +
                '‚Ä¢ Original PowerPoint files\n' +
                '‚Ä¢ Generated slide images\n' +
                '‚Ä¢ Synthesized audio files\n' +
                '‚Ä¢ Final video files\n\n' +
                'This action cannot be undone!'
            );
            
            if (!confirmed) return;
            
            // Disable button and show loading
            cleanupBtn.disabled = true;
            cleanupBtn.textContent = 'Cleaning...';
            cleanupStatus.textContent = 'üîÑ Processing cleanup...';
            cleanupStatus.style.color = 'orange';
            
            try {
                // First get preview to show what will be cleaned
                const previewResponse = await fetch(`${API_BASE_URL}/cleanup/preview?days_old=0`);
                if (previewResponse.ok) {
                    const previewData = await previewResponse.json();
                    console.log('Cleanup preview:', previewData);
                    
                    if (previewData.preview.jobs_count === 0) {
                        cleanupStatus.textContent = '‚úÖ No jobs to clean up';
                        cleanupStatus.style.color = 'green';
                        cleanupBtn.disabled = false;
                        cleanupBtn.textContent = 'Clean All Jobs';
                        return;
                    }
                }
                
                // Execute cleanup
                const response = await fetch(`${API_BASE_URL}/cleanup/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        days_old: 0,  // Clean all jobs regardless of age
                        status_filter: ['completed', 'failed']
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    cleanupStatus.textContent = `‚úÖ ${result.message}`;
                    cleanupStatus.style.color = 'green';
                    
                    // Refresh the jobs table
                    await loadAllJobs();
                } else {
                    const error = await response.json();
                    cleanupStatus.textContent = `‚ùå Cleanup failed: ${error.detail}`;
                    cleanupStatus.style.color = 'red';
                }
            } catch (error) {
                console.error('Cleanup error:', error);
                cleanupStatus.textContent = `‚ùå Cleanup failed: ${error.message}`;
                cleanupStatus.style.color = 'red';
            } finally {
                // Re-enable button
                cleanupBtn.disabled = false;
                cleanupBtn.textContent = 'Clean All Jobs';
                
                // Clear status after 5 seconds
                setTimeout(() => {
                    cleanupStatus.textContent = '';
                }, 5000);
            }
        });

        // Selective job cleanup functions
        function toggleSelectAllJobs() {
            const selectAll = document.getElementById('selectAllJobs');
            const jobCheckboxes = document.querySelectorAll('.job-checkbox');
            
            jobCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedJobCount();
        }

        function updateSelectedJobCount() {
            const checkboxes = document.querySelectorAll('.job-checkbox');
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            document.getElementById('selectedJobCount').textContent = `${count} selected`;
            document.getElementById('deleteSelectedJobsBtn').disabled = count === 0;
            
            // Update select all checkbox state
            const selectAll = document.getElementById('selectAllJobs');
            if (count === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (count === checkboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            }
        }

        async function deleteSelectedJobs() {
            const selectedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
            const selectedJobIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            if (selectedJobIds.length === 0) {
                alert('No jobs selected');
                return;
            }
            
            const jobText = selectedJobIds.length === 1 ? 'job' : 'jobs';
            if (!confirm(`Are you sure you want to delete ${selectedJobIds.length} selected ${jobText}? This will permanently remove the job records and associated files.`)) {
                return;
            }
            
            const deleteBtn = document.getElementById('deleteSelectedJobsBtn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('/api/cleanup/specific-jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_ids: selectedJobIds
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Successfully deleted ${result.cleanup_stats.jobs_deleted} jobs and ${result.cleanup_stats.files_deleted} files.`);
                    
                    // Reset selection state
                    document.getElementById('selectAllJobs').checked = false;
                    updateSelectedJobCount();
                    
                    // Refresh jobs table
                    await loadAllJobs();
                } else {
                    const error = await response.json();
                    alert(`Error deleting jobs: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting jobs:', error);
                alert('Error deleting jobs. Please check the console for details.');
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete Selected Jobs';
            }
        }

        setInterval(async () => {
            const rows = document.querySelectorAll('#jobs-table tbody tr');
            rows.forEach(async row => {
                const statusCell = row.querySelector('td:nth-child(4)'); // Updated column index due to checkbox
                if (statusCell && statusCell.textContent !== 'completed' && statusCell.textContent !== 'failed') {
                    const jobId = row.id.split('-')[1];
                    
                    // Load detailed progress instead of just status
                    loadJobProgress(jobId);
                }
            });
        }, 5000); // Poll every 5 seconds

        // Initialize voice test functionality
        document.getElementById('voice-test-form').addEventListener('submit', testVoiceSynthesis);
        
        // Load voices when page loads
        document.addEventListener('DOMContentLoaded', loadVoicesForTest);

    </script>
</body>
</html>
